<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Date Mystère ✨</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCNzUwspWX6EOqYHHmueq5nmfTTFV5LPbA",
      authDomain: "datemystere-c7580.firebaseapp.com",
      projectId: "datemystere-c7580",
      storageBucket: "datemystere-c7580.firebasestorage.app",
      messagingSenderId: "394663564435",
      appId: "1:394663564435:web:505095cc42c3ad277d6966",
      measurementId: "G-E4H4BR9C4T",
      databaseURL: "https://datemystere-c7580-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // expose db to global scope for usage in functions
    window.firebaseDB = db;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebasePush = push;
    window.firebaseOnValue = onValue;
    window.firebaseRemove = remove;
  </script>

  <style>
    /* Styles (abrégés pour lisibilité) */
  </style>
</head>
<body>
  <h1>🎉 Générateur de Date Mystère</h1>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('margaux')" id="tab-margaux">Idée Margaux</div>
    <div class="tab" onclick="askAccessCode()" id="tab-ulrich">Idée Ulric 🔐</div>
    <div class="tab" onclick="switchTab('tirage')" id="tab-tirage">Tirage au sort</div>
  </div>

  <div class="container">
    <div id="screen-margaux" class="screen active">
      <div id="ideaList"></div>
      <button onclick="addIdea()">+ Ajouter une idée</button>
      <button onclick="resetIdeas()">Réinitialiser</button>
    </div>

    <div id="screen-ulrich" class="screen">
      <div id="ulrichIdeasContainer"></div>
    </div>

    <div id="screen-tirage" class="screen">
      <h2>Tirage au Sort 🎉</h2>
      <button onclick="drawDate()">Tirer au sort une idée !</button>
      <div class="result" id="result"></div>
    </div>
  </div>

  <script>
    const ACCESS_CODE = "06081998";

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('screen-' + tab).classList.add('active');
    }

    function askAccessCode() {
      const code = prompt("Entre le code secret pour voir les idées d'Ulric :");
      if (code === ACCESS_CODE) {
        switchTab('ulrich');
        loadUlrichIdeas();
      } else {
        alert("Code incorrect !");
        switchTab('margaux');
      }
    }

    function addIdea() {
      const text = prompt("Entre ton idée de date :");
      if (!text) return;
      const db = window.firebaseDB;
      const pushRef = window.firebasePush(window.firebaseRef(db, 'margaux'));
      window.firebaseSet(pushRef, text);
    }

    function resetIdeas() {
      const confirmReset = confirm("Supprimer toutes les idées de Margaux ?");
      if (!confirmReset) return;
      const db = window.firebaseDB;
      window.firebaseRemove(window.firebaseRef(db, 'margaux'));
    }

    function loadMargauxIdeas() {
      const db = window.firebaseDB;
      const container = document.getElementById("ideaList");
      container.innerHTML = "Chargement...";
      window.firebaseOnValue(window.firebaseRef(db, 'margaux'), snapshot => {
        const data = snapshot.val();
        container.innerHTML = "";
        if (data) {
          Object.entries(data).forEach(([id, idea]) => {
            const div = document.createElement("div");
            div.textContent = idea;
            container.appendChild(div);
          });
        } else {
          container.innerHTML = "Aucune idée pour le moment.";
        }
      });
    }

    function loadUlrichIdeas() {
      const ulrich = [
        "Soirée sous les étoiles au Planétarium (je viens te chercher 🌌)",
        "Voir un match des Gothiques d’Amiens (hockey 🔥)",
        "Tour des estaminets secrets 🍻",
        "Soirée Podcast 🎧 : je t’interviewe sur un de tes voyages",
        "Soirée Quiz 🧠 : je t’impressionne (ou pas)"
      ];
      const container = document.getElementById("ulrichIdeasContainer");
      container.innerHTML = "";
      ulrich.forEach(idea => {
        const div = document.createElement("div");
        div.textContent = idea;
        container.appendChild(div);
      });
    }

    function drawDate() {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = '<div class="loading">⏳ Tirage en cours...</div>';

      setTimeout(() => {
        const db = window.firebaseDB;
        window.firebaseOnValue(window.firebaseRef(db, 'margaux'), snapshot => {
          const margaux = snapshot.val();
          const margauxList = margaux ? Object.values(margaux) : [];
          const ulrichList = [
            "Soirée sous les étoiles au Planétarium (je viens te chercher 🌌)",
            "Voir un match des Gothiques d’Amiens (hockey 🔥)",
            "Tour des estaminets secrets 🍻",
            "Soirée Podcast 🎧 : je t’interviewe sur un de tes voyages",
            "Soirée Quiz 🧠 : je t’impressionne (ou pas)"
          ];

          if (ulrichList.length === 0 && margauxList.length === 0) {
            resultDiv.textContent = "Aucune idée enregistrée.";
            return;
          }

          const pickFrom = Math.random() < 0.5 ? 'ulrich' : 'margaux';
          let drawn;
          if (pickFrom === 'ulrich' && ulrichList.length > 0) {
            drawn = { text: ulrichList[Math.floor(Math.random() * ulrichList.length)], author: "Ulric" };
          } else if (margauxList.length > 0) {
            drawn = { text: margauxList[Math.floor(Math.random() * margauxList.length)], author: "Margaux" };
          } else {
            const all = [...ulrichList.map(i => ({ text: i, author: 'Ulric' })), ...margauxList.map(i => ({ text: i, author: 'Margaux' }))];
            drawn = all[Math.floor(Math.random() * all.length)];
          }

          resultDiv.innerHTML = `💡 <strong>Idée tirée</strong><br><br><em>${drawn.text}</em><br><br><small>✨ proposée par <strong>${drawn.author}</strong></small>`;
        }, { onlyOnce: true });
      }, 1500);
    }

    window.onload = loadMargauxIdeas;
  </script>
</body>
</html>
